# monitor-server-logs

## プログラムの実行方法

本リポジトリの構成は以下のとおり。

![constitution](https://user-images.githubusercontent.com/86135975/127794940-fcfba8f2-4526-4fbd-9c48-23ff1538ac48.png)

実行方法は

カレントディレクトリを上図のrootにした状態で以下のコマンドを叩くことで実行することができる。

```bash
python Answers/answer_1.py
```

監視するログファイルはLogDataの中にまとめてある。

ログファイルは各answer.pyのmain関数にて読み込みが行われている。ファイルの指定はここに直接書き込む仕様である。


## 設問１

### アルゴリズム

- ログファイルを上から一行ずつ読み込み、タイムアウトの目印である'-'を探す。判定方法は応答時間をint型にキャストできるか。
- '-'を見つけたらその確認時間とサーバアドレスを紐づけて記録。
- その後の走査続け、**応答がある** かつ **タイムアウトしている記録がある**サーバを見つけたらその期間を出力する。2.で記録したものはこのタミングで破棄。
- 走査が終了したらタイムアウトの記録が破棄されていないものを出力。これはいまも復旧が確認されていないサーバを表している。

### 出力方法

出力は設問4まで通して使えるformatter.pyを作成した。

これは以下の３つの関数を持つ

- format_datetime

    YYYMMDDhhmmssからYYYY-MM-DD hh:mm:ssの文字列に変換を行う関数

- format_log

    サーバアドレス、故障の開始時間、返ってくるpingを投げた時間、その応答時間を引数に持つ関数。pingを投げた時間と応答時間を足したものを終了時間とする。第５引数は設問３で使用する。

- format_still

    タイムアウトのフラグ立っているが終了時間が存在しないケースで呼ばれる。

### 仕様

出力が終了時間について昇順になっている。開始時間について並んでいるほうが見やすいかもしれない。しかし、ログを上から見ながら出力していくには、終了時間が決定したタイミングで出力せざるを得ない。リアルタイム性と見やすさを天秤にかけたところ今回のプログラムの用途を鑑み、リアルタイム性を優先した。

### 実行例

```bash
python Answers/answer_1.py
```

により実行。監視するファイルはsample1.txtとする。

入力

---

20201019133124,10.20.30.1/16,2<br>
20201019133125,10.20.30.2/16,1<br>
20201019133134,192.168.1.1/24,10<br>
20201019133135,192.168.1.2/24,-<br>
20201019133224,10.20.30.1/16,522<br>
20201019133225,10.20.30.2/16,1<br>
20201019133234,192.168.1.1/24,-<br>
20201019133235,192.168.1.2/24,15<br>
20201019133324,10.20.30.1/16,2<br>
20201019133325,10.20.30.2/16,2<br>

---

出力

---

192.168.1.2/24 :   2020-10-19 13:31:35   ~    2020-10-19 13:32:35.015<br>
192.168.1.1/24 :   2020-10-19 13:32:34   ~

---

### 検証

出力が正しいか検証を行う。

入力のうちタイムアウトが起こっているのは太線の行である。

192.168.1.2/24のサーバはその後下線の行で応答を確認している。

つまり2020-10-19 13:31:35 から下線の行の2020-10-19 13:32:35にその応答時間15msを足した時間まで故障期間と見なすことができる。よって出力一行目は正しい。

192.168.1.1/24のサーバはタイムアウト後応答がない。

よって現在も故障期間とみなすことができ、こちらも出力2行目とマッチする。

20201019133124,10.20.30.1/16,2<br>
20201019133125,10.20.30.2/16,1<br>
20201019133134,192.168.1.1/24,10<br>
**20201019133135,192.168.1.2/24,-**<br>
20201019133224,10.20.30.1/16,522<br>
20201019133225,10.20.30.2/16,1<br>
**20201019133234,192.168.1.1/24,-**<br>
20201019133235,192.168.1.2/24,15<br>
20201019133324,10.20.30.1/16,2<br>
20201019133325,10.20.30.2/16,2<br>

他にタイムアウトが起きている箇所はないため、今回のテストケースでは正しい出力がでたと言える。
